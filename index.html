<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- BRANDING & SEO -->
    <title>Game Deals | The Ultimate Global Price Tracker</title>
    <meta name="description" content="Game Deals is the ultimate global game price tracker. Discover the lowest prices on PC games, manage your gaming budget, and never overpay for Steam keys again.">
    <meta name="keywords" content="game deals, steam sales, pc game discounts, budget gaming, cheapshark, game deals, price tracker">
    <meta name="author" content="Game Deals Global">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#7c3aed">

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Game Deals - Infinite Discounts">
    <meta property="og:description" content="Stop overpaying. Track live prices across 25+ stores.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1552820728-8b83bb6b773f?auto=format&fit=crop&q=80&w=1200">
    
    <!-- JSON-LD Structure for AI & Google -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Game Deals",
      "applicationCategory": "ShoppingApplication",
      "offers": {
        "@type": "AggregateOffer",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock"
      }
    }
    </script>

    <!-- Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts: Space Grotesk (Headings) & Inter (Body) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],
                        display: ['"Space Grotesk"', 'sans-serif'],
                    },
                    colors: {
                        // Branding: Electric Violet & Neon Cyan
                        loot: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            400: '#a78bfa',
                            500: '#8b5cf6', // Primary Brand Color
                            600: '#7c3aed',
                            700: '#6d28d9',
                            900: '#4c1d95',
                            950: '#2e1065', // Deep Background
                        },
                        neon: {
                            400: '#22d3ee',
                            500: '#06b6d4',
                        },
                        dark: {
                            bg: '#0B0D14',     // Ultra dark blue/black
                            card: '#151922',   // Slightly lighter
                            border: '#252A36',
                        }
                    },
                    animation: {
                        'shimmer': 'shimmer 1.5s infinite linear',
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Global Reset & Polish */
        body { 
            background-color: #f3f4f6; 
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
        }
        .dark body {
            background-color: #0B0D14;
            color: #e5e7eb;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass {
            background: rgba(21, 25, 34, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Skeleton Loading */
        .skeleton {
            background: #e5e7eb;
            background-image: linear-gradient(to right, #e5e7eb 0%, #d1d5db 20%, #e5e7eb 40%, #e5e7eb 100%);
            background-repeat: no-repeat;
            background-size: 2000px 100%; 
            animation: shimmer 1.5s infinite linear; 
        }
        .dark .skeleton {
            background: #1f2937;
            background-image: linear-gradient(to right, #1f2937 0%, #374151 20%, #1f2937 40%, #1f2937 100%);
        }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; 
            background: #8b5cf6; margin-top: -7px; cursor: pointer; box-shadow: 0 0 10px rgba(139, 92, 246, 0.5); 
        }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; height: 4px; cursor: pointer; background: #d1d5db; border-radius: 2px; 
        }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #374151; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #374151; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Configuration ---
        const API_BASE = "https://www.cheapshark.com/api/1.0";

        // --- Hooks ---
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                if (typeof window === "undefined") return initialValue;
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { return initialValue; }
            });
            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) { console.log(error); }
            };
            return [storedValue, setValue];
        };

        const useTheme = () => {
            const [theme, setTheme] = useLocalStorage('gamedeals_theme', 'dark');
            useEffect(() => {
                const root = window.document.documentElement;
                if (theme === 'dark') root.classList.add('dark');
                else root.classList.remove('dark');
            }, [theme]);
            return [theme, setTheme];
        };

        // --- Helper Components ---
        
        const AdUnit = ({ type, width, height, className }) => (
            <div className={`relative flex flex-col items-center justify-center bg-gray-200 dark:bg-dark-card border border-gray-300 dark:border-dark-border rounded-lg overflow-hidden my-6 mx-auto ${className}`} style={{ width: width ? width : '100%', height: height ? height : 'auto', minHeight: '90px' }}>
                <span className="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-0 bg-gray-300 dark:bg-dark-border px-2 py-0.5 text-[8px] tracking-widest uppercase text-gray-500 font-bold rounded-b">Advertisement</span>
                <div className="text-center opacity-40">
                    <i className="fas fa-ad text-2xl mb-1"></i>
                    <p className="text-[10px] font-mono">Game Deals Ad Network â€¢ {type}</p>
                </div>
            </div>
        );

        // --- Core Components ---

        const Navbar = ({ onSearch, toggleSidebar, activeView, setActiveView, favoritesCount, theme, setTheme, searchTerm }) => (
            <nav className="fixed top-0 w-full z-50 glass border-b border-gray-200 dark:border-dark-border h-18 shadow-lg shadow-loot-900/5">
                <div className="container mx-auto px-4 h-16 flex items-center justify-between gap-4">
                    
                    {/* Brand */}
                    <div className="flex items-center gap-4 shrink-0">
                        <button onClick={toggleSidebar} className="lg:hidden text-gray-500 dark:text-gray-400 hover:text-loot-500 transition-colors">
                            <i className="fas fa-bars text-xl"></i>
                        </button>
                        <div className="flex items-center gap-2.5 cursor-pointer group" onClick={() => setActiveView('deals')}>
                            <div className="relative w-10 h-10 flex items-center justify-center">
                                <div className="absolute inset-0 bg-loot-500 rounded-xl rotate-6 group-hover:rotate-12 transition-transform duration-300 opacity-20 blur-md"></div>
                                <div className="relative w-10 h-10 bg-gradient-to-br from-loot-600 to-loot-800 rounded-xl flex items-center justify-center text-white shadow-xl">
                                    <i className="fas fa-gamepad text-lg animate-pulse"></i>
                                </div>
                            </div>
                            <div className="flex flex-col hidden sm:flex">
                                <span className="text-xl font-display font-bold tracking-tight text-gray-900 dark:text-white leading-none">
                                    Game<span className="text-loot-500">Deals</span>
                                </span>
                                <span className="text-[10px] font-medium text-gray-500 dark:text-gray-400 tracking-wider uppercase">Price Tracker</span>
                            </div>
                        </div>
                    </div>

                    {/* Advanced Real-Time Search Bar */}
                    <div className="flex-1 max-w-2xl px-2 md:px-8">
                        <div className="relative group w-full">
                            <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i className="fas fa-search text-gray-400 group-focus-within:text-loot-500 transition-colors text-lg"></i>
                            </div>
                            <input 
                                type="text" 
                                value={searchTerm}
                                onChange={(e) => onSearch(e.target.value)}
                                placeholder="Search games (e.g., Elden Ring)..." 
                                className="block w-full pl-12 pr-12 py-2.5 bg-gray-100 dark:bg-dark-bg border border-gray-200 dark:border-dark-border focus:border-loot-500 focus:ring-2 focus:ring-loot-500/20 rounded-xl text-sm text-gray-900 dark:text-white placeholder-gray-500 transition-all shadow-inner"
                            />
                            {/* Live Badge & Clear Button */}
                            <div className="absolute inset-y-0 right-0 flex items-center pr-3 gap-2">
                                {searchTerm && (
                                    <button 
                                        onClick={() => onSearch('')}
                                        className="text-gray-400 hover:text-red-500 transition-colors p-1"
                                        aria-label="Clear Search"
                                    >
                                        <i className="fas fa-times-circle"></i>
                                    </button>
                                )}
                                <span className="hidden md:inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-loot-100 dark:bg-loot-900/30 text-loot-600 dark:text-loot-400 border border-loot-200 dark:border-loot-800 tracking-wider">
                                    LIVE
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="flex items-center gap-3 shrink-0">
                        <button 
                            onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
                            className="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 dark:text-yellow-400 hover:bg-gray-100 dark:hover:bg-dark-card transition-colors bg-white/50 dark:bg-white/5 backdrop-blur-sm border border-gray-200 dark:border-dark-border"
                        >
                            <i className={`fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}`}></i>
                        </button>
                        <button 
                            onClick={() => setActiveView('favorites')}
                            className={`group relative flex items-center gap-2 px-4 py-2 rounded-full transition-all border ${activeView === 'favorites' ? 'bg-loot-500/10 text-loot-500 border-loot-500/20' : 'bg-white/50 dark:bg-white/5 border-gray-200 dark:border-dark-border text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-card'}`}
                        >
                            <div className="relative">
                                <i className={`fas fa-heart ${activeView === 'favorites' ? 'text-loot-500' : 'text-gray-400 group-hover:text-red-400'}`}></i>
                                {favoritesCount > 0 && <span className="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-bounce"></span>}
                            </div>
                            <span className="hidden sm:inline text-sm font-medium">Wishlist</span>
                        </button>
                    </div>
                </div>
            </nav>
        );

        // Hero Component
        const Hero = ({ deals, stores }) => {
            const heroDeal = useMemo(() => {
                if(!deals || deals.length === 0) return null;
                // Weighted Score: (Savings * 1.5) + Metacritic Score. Prefer high savings on good games.
                return [...deals]
                    .filter(d => d.thumb && d.steamAppID)
                    .sort((a, b) => {
                        const scoreA = (parseFloat(a.savings) * 1.5) + (parseInt(a.metacriticScore || 0));
                        const scoreB = (parseFloat(b.savings) * 1.5) + (parseInt(b.metacriticScore || 0));
                        return scoreB - scoreA;
                    })[0];
            }, [deals]);

            if (!heroDeal) return null;

            const store = stores.find(s => s.storeID === heroDeal.storeID);
            const imgUrl = `https://cdn.cloudflare.steamstatic.com/steam/apps/${heroDeal.steamAppID}/header.jpg`;
            const boxArtUrl = `https://cdn.cloudflare.steamstatic.com/steam/apps/${heroDeal.steamAppID}/library_600x900_2x.jpg`;

            return (
                <div className="relative w-full rounded-3xl overflow-hidden mb-10 border border-gray-200 dark:border-loot-500/30 shadow-2xl shadow-loot-900/20 group animate-fade-in">
                    
                    {/* Background Blur */}
                    <div className="absolute inset-0">
                        <img src={imgUrl} className="w-full h-full object-cover opacity-10 dark:opacity-30 blur-xl scale-110" alt="" />
                        <div className="absolute inset-0 bg-gradient-to-r from-white via-white/90 to-transparent dark:from-dark-bg dark:via-dark-bg/95 dark:to-transparent/50"></div>
                        <div className="absolute inset-0 bg-gradient-to-t from-white dark:from-dark-bg via-transparent to-transparent"></div>
                    </div>

                    <div className="relative z-10 flex flex-col md:flex-row items-center p-8 md:p-12 gap-10">
                        {/* Content */}
                        <div className="flex-1 space-y-6 text-center md:text-left">
                            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gradient-to-r from-loot-600 to-loot-500 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-loot-500/30">
                                <i className="fas fa-bolt"></i> Daily Super Deal
                            </div>
                            
                            <h2 className="text-4xl md:text-6xl font-display font-bold text-gray-900 dark:text-white leading-tight drop-shadow-sm">
                                {heroDeal.title}
                            </h2>

                            <div className="flex flex-wrap justify-center md:justify-start items-center gap-6">
                                <div className="flex flex-col">
                                    <span className="text-sm text-gray-500 dark:text-gray-400 line-through font-medium">Regular: ${heroDeal.normalPrice}</span>
                                    <div className="text-5xl font-bold text-loot-600 dark:text-loot-400 tracking-tighter">${heroDeal.salePrice}</div>
                                </div>
                                <div className="h-12 w-px bg-gray-300 dark:bg-dark-border hidden md:block"></div>
                                <div className="flex flex-col items-center md:items-start">
                                    <span className="text-green-600 dark:text-green-400 font-bold text-lg">-{Math.round(heroDeal.savings)}% OFF</span>
                                    {heroDeal.metacriticScore > 0 && (
                                        <div className="flex items-center gap-1 text-sm text-gray-600 dark:text-gray-300 mt-1 bg-gray-200 dark:bg-dark-card px-2 py-0.5 rounded">
                                            <i className="fas fa-star text-yellow-500 text-xs"></i> {heroDeal.metacriticScore} Metacritic
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="pt-2">
                                <a 
                                    href={`https://www.cheapshark.com/redirect?dealID=${heroDeal.dealID}`} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="inline-flex items-center gap-3 px-8 py-4 bg-gray-900 dark:bg-white hover:bg-loot-600 dark:hover:bg-loot-400 text-white dark:text-dark-bg font-bold rounded-xl transition-all hover:scale-105 hover:shadow-xl shadow-lg shadow-black/10"
                                >
                                    <span>Get This Deal</span>
                                    <i className="fas fa-arrow-right"></i>
                                </a>
                                {store && (
                                    <p className="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                        Redeemable on <img src={`https://www.cheapshark.com${store.images.icon}`} className="w-4 h-4 inline mx-1 align-text-bottom" alt={store.storeName} /> <span className="font-bold">{store.storeName}</span>
                                    </p>
                                )}
                            </div>
                        </div>

                        {/* 3D Box Art */}
                        <div className="w-full md:w-1/3 flex justify-center perspective-1000">
                            <div className="relative group w-48 md:w-64 aspect-[2/3] transition-transform duration-500 transform md:rotate-y-12 md:group-hover:rotate-y-0">
                                <img 
                                    src={boxArtUrl} 
                                    className="w-full h-full object-cover rounded-lg shadow-2xl shadow-black/50 border border-white/10"
                                    onError={(e) => { e.target.src = heroDeal.thumb; }}
                                    alt="Box Art"
                                />
                                {/* Reflection/Glow */}
                                <div className="absolute -inset-1 bg-loot-500/30 blur-xl -z-10 group-hover:bg-loot-500/50 transition-colors"></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const BudgetPlanner = ({ favorites }) => {
            const [budget, setBudget] = useLocalStorage('gamedeals_budget', 50);
            const total = favorites.reduce((acc, curr) => acc + parseFloat(curr.salePrice), 0);
            const remaining = budget - total;
            const progress = Math.min((total / budget) * 100, 100);
            const statusColor = remaining < 0 ? 'bg-red-500' : progress > 80 ? 'bg-yellow-500' : 'bg-green-500';
            const statusText = remaining < 0 ? 'text-red-500' : progress > 80 ? 'text-yellow-500' : 'text-green-500';

            return (
                <div className="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-2xl p-6 mb-8 shadow-sm">
                    <div className="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                        <div>
                            <h3 className="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                <i className="fas fa-wallet text-loot-500"></i> Game Budget Planner
                            </h3>
                            <p className="text-xs text-gray-500">Set a limit, we'll do the math.</p>
                        </div>
                        <div className="flex items-center gap-2 bg-gray-100 dark:bg-dark-bg px-3 py-1.5 rounded-lg border border-gray-200 dark:border-dark-border">
                            <span className="text-sm font-semibold text-gray-500">$</span>
                            <input 
                                type="number" 
                                value={budget} 
                                onChange={(e) => setBudget(parseFloat(e.target.value))}
                                className="bg-transparent w-20 text-right font-bold text-gray-900 dark:text-white focus:outline-none"
                            />
                        </div>
                    </div>
                    
                    <div className="h-3 bg-gray-200 dark:bg-dark-bg rounded-full overflow-hidden mb-2">
                        <div className={`h-full transition-all duration-700 ease-out ${statusColor}`} style={{ width: `${progress}%` }}></div>
                    </div>
                    
                    <div className="flex justify-between text-xs font-bold font-mono">
                        <span className="text-gray-500">CART: ${total.toFixed(2)}</span>
                        <span className={statusText}>{remaining < 0 ? `OVER: $${Math.abs(remaining).toFixed(2)}` : `LEFT: $${remaining.toFixed(2)}`}</span>
                    </div>
                </div>
            );
        };

        const GameCard = ({ deal, stores, isFavorite, toggleFavorite }) => {
            const store = stores.find(s => s.storeID === deal.storeID);
            const imgUrl = deal.steamAppID ? `https://cdn.cloudflare.steamstatic.com/steam/apps/${deal.steamAppID}/header.jpg` : deal.thumb;

            return (
                <div className="group relative bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-2xl overflow-hidden hover:border-loot-500/50 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 flex flex-col h-full">
                    <div className="relative aspect-video bg-gray-800 overflow-hidden">
                        <img 
                            src={imgUrl} 
                            alt={deal.title}
                            loading="lazy"
                            className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                            onError={(e) => { e.target.src = deal.thumb || 'https://placehold.co/600x400/1f2937/FFF?text=No+Image'; }}
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-60"></div>
                        
                        <div className="absolute top-2 right-2">
                            <span className={`px-2 py-1 rounded-md text-[10px] font-bold shadow-sm text-white ${parseFloat(deal.savings) > 75 ? 'bg-red-500' : 'bg-loot-600'}`}>
                                -{Math.round(deal.savings)}%
                            </span>
                        </div>
                        
                        <button 
                            onClick={(e) => { e.preventDefault(); toggleFavorite(deal); }}
                            className="absolute top-2 left-2 w-8 h-8 rounded-full bg-black/40 backdrop-blur-md flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-all hover:bg-white hover:text-red-500"
                        >
                            <i className={`${isFavorite ? 'fas text-red-500' : 'far'} fa-heart`}></i>
                        </button>
                    </div>

                    <div className="p-4 flex-1 flex flex-col justify-between">
                        <div>
                            <div className="flex items-center gap-2 mb-2">
                                {store && (
                                    <div className="flex items-center gap-1.5 text-[10px] uppercase font-bold text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-dark-bg px-1.5 py-0.5 rounded">
                                        <img src={`https://www.cheapshark.com${store.images.icon}`} className="w-3 h-3" alt="" />
                                        {store.storeName}
                                    </div>
                                )}
                            </div>
                            <h3 className="text-base font-bold text-gray-900 dark:text-gray-100 leading-tight line-clamp-2 mb-1 group-hover:text-loot-500 transition-colors" title={deal.title}>
                                {deal.title}
                            </h3>
                        </div>

                        <div className="mt-4 pt-3 border-t border-gray-100 dark:border-dark-border/50 flex items-end justify-between">
                            <div className="flex flex-col">
                                <span className="text-xs text-gray-400 line-through">${deal.normalPrice}</span>
                                <span className="text-lg font-bold text-loot-600 dark:text-white">${deal.salePrice}</span>
                            </div>
                            <a 
                                href={`https://www.cheapshark.com/redirect?dealID=${deal.dealID}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="px-3 py-1.5 bg-gray-100 dark:bg-dark-bg hover:bg-loot-500 hover:text-white text-gray-700 dark:text-gray-300 text-xs font-bold rounded-lg transition-colors uppercase tracking-wide"
                            >
                                View Deal
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ isOpen, close, filters, setFilters, stores }) => (
            <>
                {isOpen && <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 lg:hidden" onClick={close}></div>}
                <aside className={`fixed top-16 bottom-0 left-0 w-72 bg-white dark:bg-dark-card border-r border-gray-200 dark:border-dark-border z-40 transform transition-transform duration-300 overflow-y-auto ${isOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                    <div className="p-6 space-y-8">
                        
                        {/* Sidebar Ad Slot */}
                        <AdUnit type="Sidebar Square" width="100%" height="250px" />

                        {/* Sort */}
                        <div className="space-y-3">
                            <h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest">Sort Strategy</h3>
                            <div className="grid grid-cols-2 gap-2">
                                {[{id: 'DealRating', label: 'Best Value'}, {id: 'Savings', label: 'Max Discount'}, {id: 'Price', label: 'Lowest Price'}, {id: 'Metacritic', label: 'Top Rated'}].map(opt => (
                                    <button 
                                        key={opt.id}
                                        onClick={() => setFilters({...filters, sortBy: opt.id})}
                                        className={`px-2 py-2 rounded-lg text-xs font-bold border transition-all ${filters.sortBy === opt.id ? 'bg-loot-50 border-loot-500 text-loot-600 dark:bg-loot-500/20 dark:text-loot-300' : 'border-gray-200 dark:border-dark-border text-gray-500 hover:bg-gray-50 dark:hover:bg-dark-bg'}`}
                                    >
                                        {opt.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Price Range */}
                        <div className="space-y-4">
                            <div className="flex justify-between items-center">
                                <label className="text-xs font-bold text-gray-500 uppercase">Under Price</label>
                                <span className="text-sm font-mono font-bold text-loot-500">${filters.upperPrice}</span>
                            </div>
                            <input type="range" min="0" max="60" step="1" value={filters.upperPrice} onChange={(e) => setFilters({...filters, upperPrice: e.target.value})} className="w-full accent-loot-500" />
                        </div>

                        {/* Toggles */}
                        <div className="space-y-3">
                            <h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest">Filters</h3>
                            {[
                                { key: 'AAA', label: 'AAA Titles Only' },
                                { key: 'steamworks', label: 'Steam Keys' },
                                { key: 'onSale', label: 'On Sale Now' }
                            ].map(toggle => (
                                <label key={toggle.key} className="flex items-center justify-between cursor-pointer group">
                                    <span className="text-sm font-medium text-gray-600 dark:text-gray-400 group-hover:text-loot-500 transition-colors">{toggle.label}</span>
                                    <div className={`w-10 h-5 rounded-full relative transition-colors ${filters[toggle.key] ? 'bg-loot-500' : 'bg-gray-300 dark:bg-gray-700'}`}>
                                        <input type="checkbox" className="hidden" checked={!!filters[toggle.key]} onChange={(e) => setFilters({...filters, [toggle.key]: e.target.checked ? 1 : 0})} />
                                        <div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-transform shadow-sm ${filters[toggle.key] ? 'left-6' : 'left-1'}`}></div>
                                    </div>
                                </label>
                            ))}
                        </div>

                        {/* Stores */}
                        <div className="space-y-2 pb-10">
                            <h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Marketplaces</h3>
                            <div className="space-y-1">
                                {stores.filter(s => s.isActive).map(store => {
                                    const isSelected = (filters.storeID || '').split(',').includes(store.storeID);
                                    return (
                                        <div 
                                            key={store.storeID}
                                            onClick={() => {
                                                const current = filters.storeID ? filters.storeID.split(',') : [];
                                                const updated = current.includes(store.storeID) ? current.filter(x => x !== store.storeID) : [...current, store.storeID];
                                                setFilters({...filters, storeID: updated.join(',')});
                                            }}
                                            className={`flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer transition-all ${isSelected ? 'bg-loot-50 dark:bg-loot-500/10 text-loot-600 dark:text-loot-300' : 'text-gray-500 hover:bg-gray-50 dark:hover:bg-dark-bg'}`}
                                        >
                                            <img src={`https://www.cheapshark.com${store.images.icon}`} className="w-4 h-4 opacity-70" alt="" />
                                            <span className="text-sm font-medium">{store.storeName}</span>
                                            {isSelected && <i className="fas fa-check ml-auto text-xs text-loot-500"></i>}
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </div>
                </aside>
            </>
        );

        // --- Main App ---
        const App = () => {
            const [theme, setTheme] = useTheme();
            const [activeView, setActiveView] = useState('deals'); 
            const [stores, setStores] = useState([]);
            const [deals, setDeals] = useState([]);
            const [favorites, setFavorites] = useLocalStorage('gamedeals_favorites', []);
            const [loading, setLoading] = useState(true);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            
            const [filters, setFilters] = useState({
                storeID: '', pageNumber: 0, pageSize: 28, sortBy: 'DealRating',
                desc: 0, lowerPrice: 0, upperPrice: 50, AAA: 0, steamworks: 0, onSale: 1
            });

            // 1. Fetch Stores
            useEffect(() => {
                fetch(`${API_BASE}/stores`).then(r => r.json()).then(setStores).catch(console.error);
            }, []);

            // 2. Fetch Deals & Deduplicate
            useEffect(() => {
                const controller = new AbortController();
                const fetchData = async () => {
                    setLoading(true);
                    try {
                        const params = new URLSearchParams();
                        Object.entries(filters).forEach(([k, v]) => {
                            if (v !== '' && v !== null) params.append(k, v);
                        });
                        if(searchTerm) params.append('title', searchTerm);

                        const res = await fetch(`${API_BASE}/deals?${params.toString()}`, { signal: controller.signal });
                        if(!res.ok) throw new Error('API Error');
                        const rawData = await res.json();
                        
                        // Deduplication Logic: Keep lowest price per GameID
                        const uniqueMap = new Map();
                        rawData.forEach(deal => {
                            if (!uniqueMap.has(deal.gameID)) {
                                uniqueMap.set(deal.gameID, deal);
                            } else {
                                const existing = uniqueMap.get(deal.gameID);
                                if (parseFloat(deal.salePrice) < parseFloat(existing.salePrice)) {
                                    uniqueMap.set(deal.gameID, deal);
                                }
                            }
                        });
                        setDeals(Array.from(uniqueMap.values()));
                    } catch (err) {
                        if (err.name !== 'AbortError') console.error(err);
                    } finally {
                        setLoading(false);
                    }
                };
                const timeout = setTimeout(fetchData, 300); 
                return () => { clearTimeout(timeout); controller.abort(); }
            }, [filters, searchTerm]);

            // Handlers
            const handleSearch = (term) => { setSearchTerm(term); setFilters({...filters, pageNumber: 0}); setActiveView('deals'); };
            const toggleFavorite = (deal) => {
                const exists = favorites.find(f => f.dealID === deal.dealID);
                setFavorites(exists ? favorites.filter(f => f.dealID !== deal.dealID) : [...favorites, deal]);
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <Navbar 
                        onSearch={handleSearch} toggleSidebar={() => setSidebarOpen(!sidebarOpen)}
                        activeView={activeView} setActiveView={setActiveView}
                        favoritesCount={favorites.length} theme={theme} setTheme={setTheme}
                        searchTerm={searchTerm}
                    />

                    <div className="flex pt-16 flex-1">
                        <Sidebar 
                            isOpen={sidebarOpen} close={() => setSidebarOpen(false)} 
                            filters={filters} setFilters={setFilters} stores={stores}
                        />

                        <main className="flex-1 lg:ml-72 p-4 lg:p-8 w-full max-w-[1600px] mx-auto">
                            
                            {/* Start of Content Ad (Top) */}
                            <AdUnit type="Top Leaderboard" width="100%" height="90px" className="hidden md:flex mb-8" />

                            {activeView === 'favorites' ? (
                                <div className="animate-fade-in max-w-7xl mx-auto">
                                    
                                    {/* Navigation Back Button */}
                                    <div className="mb-6">
                                        <button 
                                            onClick={() => setActiveView('deals')} 
                                            className="inline-flex items-center gap-2 text-gray-500 hover:text-loot-500 transition-colors font-medium text-sm group"
                                        >
                                            <div className="w-8 h-8 rounded-full bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border flex items-center justify-center group-hover:border-loot-500 transition-colors shadow-sm">
                                                <i className="fas fa-arrow-left"></i>
                                            </div>
                                            Back to Deals
                                        </button>
                                    </div>

                                    <div className="flex items-center justify-between mb-8 pb-4 border-b border-gray-200 dark:border-dark-border">
                                        <h1 className="text-3xl font-display font-bold text-gray-900 dark:text-white">Your Loot Stash</h1>
                                        <button onClick={() => setFavorites([])} className="text-sm text-red-500 hover:text-red-600 font-medium tracking-wide">CLEAR ALL</button>
                                    </div>
                                    
                                    {/* Wishlist Ad */}
                                    <AdUnit type="Wishlist Banner" width="100%" height="90px" />

                                    {favorites.length > 0 && <BudgetPlanner favorites={favorites} />}

                                    {favorites.length === 0 ? (
                                        <div className="text-center py-32 bg-white dark:bg-dark-card rounded-2xl border border-dashed border-gray-300 dark:border-dark-border">
                                            <i className="fas fa-ghost text-6xl text-gray-300 dark:text-gray-700 mb-4"></i>
                                            <h3 className="text-xl font-bold text-gray-900 dark:text-white">It's a ghost town here</h3>
                                            <button onClick={() => setActiveView('deals')} className="mt-6 px-6 py-2 bg-loot-600 text-white rounded-lg font-bold hover:bg-loot-500 transition-colors">Find Game Deals</button>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                            {favorites.map(deal => (
                                                <GameCard key={deal.dealID} deal={deal} stores={stores} isFavorite={true} toggleFavorite={toggleFavorite} />
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <>
                                    {/* HERO Ad */}
                                    {!loading && !searchTerm && filters.pageNumber === 0 && (
                                        <>
                                            <Hero deals={deals} stores={stores} />
                                            <AdUnit type="Post-Hero Banner" width="100%" height="90px" />
                                        </>
                                    )}

                                    {/* Grid Header */}
                                    <div className="flex items-end justify-between mb-6">
                                        <div>
                                            <h2 className="text-2xl font-display font-bold text-gray-900 dark:text-white">
                                                {searchTerm ? `Search: "${searchTerm}"` : 'Live Feed'}
                                            </h2>
                                            <p className="text-sm text-gray-500 dark:text-gray-400">Scanning {stores.length} global stores in real-time.</p>
                                        </div>
                                    </div>

                                    {/* Grid */}
                                    {loading ? (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                            {[...Array(8)].map((_, i) => (
                                                <div key={i} className="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-2xl overflow-hidden h-64">
                                                    <div className="skeleton h-32 w-full"></div>
                                                    <div className="p-4 space-y-3">
                                                        <div className="skeleton h-4 w-3/4 rounded"></div>
                                                        <div className="skeleton h-3 w-1/2 rounded"></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : deals.length === 0 ? (
                                        <div className="text-center py-32">
                                            <p className="text-xl text-gray-500">No signals found in the network.</p>
                                            <button onClick={() => setFilters({ ...filters, upperPrice: 50, title: '' })} className="mt-4 text-loot-500 underline">Reset Scanners</button>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                                {deals.map((deal, idx) => (
                                                    <React.Fragment key={deal.dealID}>
                                                        <GameCard 
                                                            deal={deal} 
                                                            stores={stores} 
                                                            isFavorite={favorites.some(f => f.dealID === deal.dealID)}
                                                            toggleFavorite={toggleFavorite}
                                                        />
                                                        {/* In-Feed Ad Logic */}
                                                        {(idx === 7 || idx === 19) && (
                                                            <div className="col-span-full">
                                                                <AdUnit type="In-Feed Content" height="120px" />
                                                            </div>
                                                        )}
                                                    </React.Fragment>
                                                ))}
                                            </div>

                                            {/* Pagination */}
                                            <div className="mt-12 flex justify-center items-center gap-4">
                                                <button 
                                                    onClick={() => { window.scrollTo(0,0); setFilters({...filters, pageNumber: Math.max(0, filters.pageNumber - 1)}); }}
                                                    disabled={filters.pageNumber === 0}
                                                    className="px-6 py-2 bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg text-gray-700 dark:text-gray-300 hover:border-loot-500 transition-colors disabled:opacity-50"
                                                >
                                                    Previous
                                                </button>
                                                <span className="text-gray-500 font-mono text-sm">Sector {filters.pageNumber + 1}</span>
                                                <button 
                                                    onClick={() => { window.scrollTo(0,0); setFilters({...filters, pageNumber: filters.pageNumber + 1}); }}
                                                    className="px-6 py-2 bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg text-gray-700 dark:text-gray-300 hover:border-loot-500 transition-colors"
                                                >
                                                    Next
                                                </button>
                                            </div>
                                        </>
                                    )}

                                    {/* Ending Point of Content Ad */}
                                    <AdUnit type="Footer Leaderboard" width="100%" height="90px" className="mt-12" />
                                </>
                            )}
                            
                            <footer className="mt-10 border-t border-gray-200 dark:border-dark-border pt-8 pb-8 text-center">
                                <p className="text-gray-500 text-sm">&copy; {new Date().getFullYear()} Game Deals. Not affiliated with Steam, Epic, or Valve.</p>
                                <div className="flex justify-center gap-4 mt-4 text-xs text-gray-400">
                                    <a href="#" className="hover:text-loot-500">Privacy</a>
                                    <a href="#" className="hover:text-loot-500">Terms</a>
                                    <a href="#" className="hover:text-loot-500">API</a>
                                </div>
                            </footer>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


